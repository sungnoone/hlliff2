"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@liff/consts"),t=require("@liff/util"),r=require("@liff/is-in-client"),n=require("@liff/is-api-available"),i=require("tslib"),o=require("@liff/logger"),s=require("@liff/get-os"),a=require("@liff/server-api"),u=require("@liff/store"),c=require("@liff/message-bus"),f=require("@liff/is-sub-window"),l=require("@liff/close-window");function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var _=d(c);function S(e){var t=a.getEndPoint("subWindowGetOrigin");return a.fetch(t(e))}var I={};function w(e,t){e&&I[e]&&I[e].forEach((function(e){e(t)}))}var v,m,g,h,p,E=function(){function r(e){this.storage=e}return r.prototype.getItem=function(e){return this.storage.getItem(this.getKeyPrefix()+":"+e)},r.prototype.setItem=function(e,t){this.storage.setItem(this.getKeyPrefix()+":"+e,t)},r.prototype.removeItem=function(e){this.storage.removeItem(this.getKeyPrefix()+":"+e)},r.prototype.clear=function(){this.storage.clear()},r.prototype.getKeyPrefix=function(){return e.STORE_KEY+":"+this.getLiffId()},r.prototype.getLiffId=function(){var r=u.getConfig().liffId;if(!r)throw t.createLiffError(e.INVALID_CONFIG,"liffId is necessary for liff.init()");return r},r}(),N=new E(t.inMemoryStorage);function T(){var e=N.getItem("subWindowStatusUpdated");return null!==e&&JSON.parse(e)}function O(e){N.setItem("subWindowStatusUpdated",String(e))}function U(e){v=e}function W(){return v}function L(){return g}function b(){return h}function A(e){return void 0===e&&(e=c.WINDOW.MAIN),i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(t){switch(t.label){case 0:return[4,(p=new _.default(e)).setup()];case 1:return t.sent(),[2,p]}}))}))}function D(){return p}var C=new E(window.sessionStorage);function B(){return C.getItem("mainWindowOrigin")}function y(r,n){return void 0===n&&(n={}),i.__awaiter(this,void 0,void 0,(function(){var s,a,c,f,l,d,_,I;return i.__generator(this,(function(i){switch(i.label){case 0:if(null==(s=D())?void 0:s.isReady())return[3,5];if(a=JSON.stringify(n),c=u.getConfig().liffId,f=B(),!window.opener||!f||!c)throw t.createLiffError(e.EXCEPTION_IN_SUBWINDOW);l=!1,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,S(c)];case 2:return d=i.sent(),l=d.subwindowCommonModule,[3,4];case 3:throw _=i.sent(),o.logger.debug(_),t.createLiffError(e.EXCEPTION_IN_SUBWINDOW);case 4:return I=l?f:location.origin,[2,new Promise((function(t){window.addEventListener("message",(function n(i){(function(t){if(t.data&&"string"==typeof t.data.type&&[e.SUB_WINDOW_STATUS.SUBMIT,e.SUB_WINDOW_STATUS.CANCEL].includes(t.data.type))return!0;return!1})(i)&&(window.removeEventListener("message",n),t({status:r,result:a}))})),window.opener.postMessage({status:r,result:a},I)}))];case 5:return s.send({eventName:r,data:n}),[4,new Promise((function(e){setTimeout(e,500)}))];case 6:return i.sent(),[2,{status:r,result:JSON.stringify(n)}]}}))}))}function P(t){var r,n=b();if(t.origin===n){var i=t.data;if(i){var s,a=i.status,u=i.result;try{s=JSON.parse(u||"{}")}catch(c){s={}}switch(a){case e.SUB_WINDOW_HEALTH_CHECK_MESSAGE:window.clearInterval(L()),x();break;case e.SUB_WINDOW_STATUS.CANCEL:case e.SUB_WINDOW_STATUS.SUBMIT:O(!0),window.clearInterval(L()),window.removeEventListener("message",P),w(a,s),null===(r=W())||void 0===r||r.postMessage({type:a},b());break;default:o.logger.debug("unexpected message")}}}}var M=function(t){return i.__awaiter(void 0,void 0,void 0,(function(){var r,n,o,s;return i.__generator(this,(function(i){if(T())return[2];switch(r=t.context,n=r.eventName,o=r.data,s=D(),n){case e.SUB_WINDOW_STATUS.INIT:H(!o.hasOpener);break;case e.SUB_WINDOW_STATUS.CANCEL:case e.SUB_WINDOW_STATUS.SUBMIT:O(!0),w(n,o),null==s||s.reply(t,{eventName:n});break;case e.SUB_WINDOW_STATUS.CLOSE:!1===T()&&(O(!0),w(e.SUB_WINDOW_STATUS.CLOSE,{})),x()}return[2]}))}))};function R(){window.clearInterval(m),window.clearInterval(L()),window.removeEventListener("message",P)}function H(e){if(void 0===e&&(e=!1),R(),O(!1),e){var t=W();t&&(t.close(),U(null))}}function x(){return i.__awaiter(this,void 0,void 0,(function(){var e;return i.__generator(this,(function(t){switch(t.label){case 0:return(e=D())?[4,e.teardown()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}function K(r){return i.__awaiter(this,void 0,void 0,(function(){var n,o,a,u,f,l,d,_,I,v;return i.__generator(this,(function(p){switch(p.label){case 0:return(n=t.extractLiffId(r.url))?(H(!0),[4,x()]):[2,Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"params.url must be liff url"))];case 1:return p.sent(),o=r.url,a=r.appData,(u=new URL(o)).searchParams.append(e.SUB_WINDOW_IDNTIFICATION_KEY,"true"),[4,A()];case 2:return f=p.sent(),u.searchParams.append(c.IDENTIFIER_KEY,f.identification.identifier),u.searchParams.append(c.CRYPTO_KEY,f.identification.cryptoKey),u.hostname=function(e){var t=i.__read(e.split(".")),r=t[0],n=t.slice(1);return i.__spread([r+"-ext"],n).join(".")}(u.hostname),l=u.toString(),U("ios"!==s.getOS()||t.isIpad()?window.open("","liffsubwindow","width=480, height=640, menubar=no, toolbar=no, scrollbars=yes"):window.open()),[4,S(n)];case 3:if(d=p.sent(),_=d.origin,I=d.subwindowCommonModule,!(v=W()))throw t.createLiffError(e.CREATE_SUBWINDOW_FAILED);return I?(function(e){h=e}(_),f.listen(M),f.setData("appData",a),window.addEventListener("message",P),v.location.href=l,E=function(t,r){var n=W(),i={type:e.SUB_WINDOW_HEALTH_CHECK_MESSAGE};return r&&(i.message=JSON.stringify(r)),window.setInterval((function(){null==n||n.postMessage(i,t)}),e.SUB_WINDOW_HEALTH_CHECK_INTERVAL)}(_,a),g=E,function(e){m=e}(window.setInterval((function(){var t=W();t&&t.closed&&(R(),U(null),!1===T()&&(O(!0),w(e.SUB_WINDOW_STATUS.CLOSE,{})))}),e.SUB_WINDOW_MONITOR_CLOSE_INTERVAL)),[2]):(v.close(),[2])}var E}))}))}function j(r){return i.__awaiter(this,void 0,void 0,(function(){var n,o,s,u,c,f,l,d,_,S,I;return i.__generator(this,(function(i){switch(i.label){case 0:n=r.msit,o=r.mstChallenge,s=r.onSuccess,u=r.onError,c=r.reconnectCount,f=void 0===c?0:c,i.label=1;case 1:return i.trys.push([1,3,,6]),[4,a.requestWithoutErrorHandling(a.getEndPoint("subWindowSubscribe"),{method:"POST",body:JSON.stringify({msit:n,mstChallenge:o})})];case 2:return l=i.sent(),[3,6];case 3:return i.sent(),[4,G()];case 4:return i.sent(),[4,V(j,{msit:n,mstChallenge:o,onSuccess:s,onError:u,reconnectCount:f+=1})];case 5:return i.sent(),[2];case 6:return l.status>=500?[4,G()]:[3,9];case 7:return i.sent(),[4,V(j,{msit:n,mstChallenge:o,onSuccess:s,onError:u,reconnectCount:f+=1})];case 8:return i.sent(),[3,20];case 9:return l.status>=400&&500>l.status?[4,q(l)]:[3,11];case 10:return(_=i.sent())?(d=_.errorDetail,u(t.createLiffError(e.INVALID_ARGUMENT,d))):u(t.createLiffError(e.UNKNOWN,"Some error happened in the server")),[3,20];case 11:return 200!==l.status?[3,19]:[4,q(l)];case 12:return(_=i.sent())?[3,13]:(u(t.createLiffError(e.UNKNOWN,"Some error happened in the server")),[3,18]);case 13:switch(S=_.status,I=_.result,S){case e.SUB_WINDOW_STATUS.ERROR:return[3,14];case e.SUB_WINDOW_STATUS.CLOSE:case e.SUB_WINDOW_STATUS.CANCEL:case e.SUB_WINDOW_STATUS.SUBMIT:return[3,16]}return[3,17];case 14:return[4,V(j,{msit:n,mstChallenge:o,onSuccess:s,onError:u,reconnectCount:f})];case 15:return i.sent(),[3,18];case 16:return s(S,I),[3,18];case 17:u(t.createLiffError(e.UNKNOWN,"Some error happened in the server")),i.label=18;case 18:return[3,20];case 19:u(t.createLiffError(e.UNKNOWN,"Some error happened in the server")),i.label=20;case 20:return[2]}}))}))}function G(){return new Promise((function(e){return setTimeout(e,1e3)}))}function q(e){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,e.json()];case 1:return[2,t.sent()];case 2:return t.sent(),[2,null];case 3:return[2]}}))}))}function V(r,n){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(i){switch(i.label){case 0:return n.reconnectCount>=10?(n.onError(t.createLiffError(e.UNKNOWN,"Failed to connect")),[3,3]):[3,1];case 1:return[4,r(n)];case 2:i.sent(),i.label=3;case 3:return[2]}}))}))}function J(e){var t={};return Object.keys(e).forEach((function(r){"closeButtonColor"===r?"white"===e[r]?t[r]="#ffffff":t[r]="#000000":t[r]=e[r]})),t}var F={height:"full",closeButtonPosition:"right",closeButtonColor:"black",closeButtonLabel:""};function Z(r){var n=r.appData,i=r.native,o=u.getConfig().liffId,s=u.getMSTChallenge(),c=t.extractLiffId(r.url);if(!o)return Promise.reject(t.createLiffError(e.UNAUTHORIZED,"liffId is invalid"));if(!s)return Promise.reject(t.createLiffError(e.UNAUTHORIZED,"mst_challenge is invalid"));if(!c)return Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"params.url must be liff url"));var f=Object.assign({},F,i);return function(r){var n=r.mainLiffId,i=r.subLiffId,o=r.mstChallenge,s=r.appData,u=r.view;return n&&o?a.fetch(a.getEndPoint("subWindowGetMSIT"),{method:"POST",body:JSON.stringify({mainLiffId:n,subLiffId:i,mstChallenge:o,appData:s,view:u})}):Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"no proper argument"))}({mainLiffId:o,subLiffId:c,mstChallenge:s,appData:n,view:J(f)}).then((function(t){var n=t.msit;j({msit:n,mstChallenge:s,onSuccess:function(e,t){w(e,t)},onError:function(t){w(e.SUB_WINDOW_STATUS.ERROR,t)}}),function(t,r){var n=t.url,i=new URLSearchParams;i.set("msit",r),location.href=e.SUB_WINDOW_MODAL_SCHEME_URL+"?url="+encodeURIComponent(n)+"&"+i.toString()}(r,n)}))}function k(){if(!f.isSubWindow())throw t.createLiffError(e.UNAUTHORIZED,"this api can be only called in child window")}function Y(r){if(!r.mst||!r.status)return Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"no proper argument"));var n=JSON.stringify(r);return a.fetch(a.getEndPoint("subWindowPost"),{method:"POST",body:n})}var X={on:function(e,t){I[e]||(I[e]=[]),I[e].push(t)},off:function(e,t){if(I[e]){var r=I[e].indexOf(t);r>=0&&I[e].splice(r,1)}},open:function(i){if(!n.isApiAvailable("subwindowOpen"))throw t.createLiffError(e.FORBIDDEN,"No permission for liff.subWindow.open()");if(!t.isLIFFBrowser()&&t.isLINEBrowser())throw t.createLiffError(e.FORBIDDEN,"Subwindow is not supported in this browser");return function(){if(f.isSubWindow())throw t.createLiffError(e.UNAUTHORIZED,"this api can be only called in parent window")}(),r.isInClient()?Z(i):K(i)},cancel:function(n){return void 0===n&&(n={}),k(),r.isInClient()?function(r){return void 0===r&&(r={}),i.__awaiter(this,void 0,void 0,(function(){var n,o;return i.__generator(this,(function(i){switch(i.label){case 0:return(n=u.getMST())?[4,Y({mst:n,status:e.SUB_WINDOW_STATUS.CANCEL,result:r})]:[2,Promise.reject(t.createLiffError(e.UNAUTHORIZED,"mst is invalid"))];case 1:return o=i.sent(),O(!0),[2,o]}}))}))}(n):function(t){return void 0===t&&(t={}),y(e.SUB_WINDOW_STATUS.CANCEL,t)}(n)},submit:function(n){return void 0===n&&(n={}),k(),r.isInClient()?function(r){return void 0===r&&(r={}),i.__awaiter(this,void 0,void 0,(function(){var n,o;return i.__generator(this,(function(i){switch(i.label){case 0:return(n=u.getMST())?[4,Y({mst:n,status:e.SUB_WINDOW_STATUS.SUBMIT,result:r})]:[2,Promise.reject(t.createLiffError(e.UNAUTHORIZED,"mst is invalid"))];case 1:return o=i.sent(),O(!0),[2,o]}}))}))}(n):function(t){return void 0===t&&(t={}),y(e.SUB_WINDOW_STATUS.SUBMIT,t)}(n)},close:function(){return k(),r.isInClient()?function(){return i.__awaiter(this,void 0,void 0,(function(){var r;return i.__generator(this,(function(n){switch(n.label){case 0:return!1!==T()?[3,2]:(r=u.getMST())?[4,Y({mst:r,status:e.SUB_WINDOW_STATUS.CLOSE,result:{}})]:[2,Promise.reject(t.createLiffError(e.UNAUTHORIZED,"mst is invalid"))];case 1:n.sent(),n.label=2;case 2:return l.closeWindow(),[2]}}))}))}():function(){return i.__awaiter(this,void 0,void 0,(function(){var t;return i.__generator(this,(function(r){return(null==(t=D())?void 0:t.isReady())?(t.send({eventName:e.SUB_WINDOW_STATUS.CLOSE}),[2,new Promise((function(t){setTimeout((function(){l.closeWindow(),t()}),e.SUB_WINDOW_HEALTH_CHECK_INTERVAL)}))]):(l.closeWindow(),[2,Promise.resolve()])}))}))}()},getAppData:function(){return k(),function(){var e,t=u.getAppData();try{e=t?JSON.parse(t):{}}catch(r){e={}}return Promise.resolve(e)}()}};exports.getAppData=function(r){var n=r.mst;return n?a.fetch(a.getEndPoint("subWindowGetAppData"),{method:"POST",body:JSON.stringify({mst:n})}):Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"no proper argument"))},exports.getMSTByMSIT=function(r){var n=r.msit,i=r.mstVerifier;return n&&i?a.fetch(a.getEndPoint("subWindowGetMSTByMSIT"),{method:"POST",body:JSON.stringify({msit:n,mstVerifier:i})}):Promise.reject(t.createLiffError(e.INVALID_ARGUMENT,"no proper argument"))},exports.getMainWindowOrigin=B,exports.getMessageBus=D,exports.initMessageBus=A,exports.setMainWindowOrigin=function(e){C.setItem("mainWindowOrigin",e)},exports.subWindow=X;
